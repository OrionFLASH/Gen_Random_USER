---

# Генератор и агрегатор посещений сотрудников

## Описание

Этот проект позволяет **генерировать** синтетические данные о сотрудниках и их посещениях (режим `GENERATE`) и **агрегировать** и анализировать эти данные с учетом бизнес-логики по периодам (режим `AGGREGATE`).
Система поддерживает гибкую настройку параметров, в том числе правила разметки периодов для анализа активности по месяцам, неделям, двухнедельным интервалам.

## Возможности

* **Генерация штатных сотрудников** с уникальными ФИО, табельными номерами, распределением по ролям и подразделениям.
* **Генерация событий посещений** (с учётом разных режимов активности сотрудников).
* **Агрегация и анализ** посещений по сотрудникам, ролям, периодам (месяц, неделя, две недели).
* **Возможность задания "гибких границ" периодов** для аналитических отчётов.
* **Автоматическое формирование сводных отчётов** (CSV, Excel).
* **Подробное логирование** с записью времени работы каждого этапа и статистики.

---

## Установка и требования

* Python 3.10+
* pandas
* openpyxl
* dateutil

Установите зависимости:

```bash
pip install pandas openpyxl python-dateutil
```

---

## Настройка параметров

Все ключевые параметры задаются в начале файла `main.py`.

### Общие параметры режима

* `MODE`: `"GENERATE"` — генерация данных; `"AGGREGATE"` — агрегация и анализ.

### Генерация (`PARAMS`, `VISIT_PARAMS`)

#### `PARAMS`

* `input_dir`: Каталог, где лежат исходные файлы (например, оргструктура).
* `org_unit_file`: CSV с оргструктурой подразделений.
* `output_dir`: Куда сохранять сгенерированные данные.
* `output_base`: Имя файла для штатного расписания (без расширения).
* `log_dir`, `log_base`: Куда писать логи.
* `user_count`: Сколько сотрудников генерировать.
* `role_distribution`: Распределение сотрудников по ролям (словарь: роль → количество).

#### `VISIT_PARAMS`

* `visit_out_dir`, `visit_out_base`: Куда сохранять посещения.
* `visit_start_date`, `visit_end_date`: Диапазон дат посещений.
* `visit_target_row_count`: Сколько строк (посещений) генерировать.

### Агрегация (`AGG_PARAMS`)

* `input_dir`, `input_base`, `input_role_base`: Где брать исходные данные посещений и штатки.
* `output_dir`, `output_base`: Куда сохранять агрегированные данные.
* `log_dir`, `log_base`: Логи.
* **Обязательные имена полей**: для таб.номера, ФИО, роли, подразделения, даты посещения, признака посещения.
* **Параметры для логики периодов**:

  * `period_day_month_border` *(int, по умолч. 7)* — число дней в начале месяца, до которого текущий месяц при расчёте периода M-0 включает также и прошлый месяц полностью.
  * `period_weekday_border` *(int, по умолч. 1)* — номер дня недели (0=Понедельник, 1=Вторник и т.д.), до которого текущая неделя (или 2 недели) при расчёте N-0 и 2N-0 считается "раздвинутой" назад (захватывает предыдущие периоды).

Пример блока:

```python
AGG_PARAMS = {
    ...
    "period_day_month_border": 7,    # смещение M-0
    "period_weekday_border": 1,      # смещение N-0 и 2N-0 (например, вторник)
}
```

---

## Логика работы

### Режим генерации (`GENERATE`)

1. Загружается оргструктура.
2. Генерируются сотрудники:

   * Уникальные ФИО, табельные номера, роли, подразделения.
   * Генерация уникальных и случайных значений при необходимости.
3. Генерируются посещения:

   * Каждый сотрудник получает шаблон посещаемости (активный, обычный, редкий).
   * Даты посещений случайны, но число строк строго соответствует `visit_target_row_count`.
   * Данные сохраняются в CSV и Excel.
4. В логах фиксируются:

   * Время работы каждого этапа и всего режима.
   * Сколько сгенерировано сотрудников, посещений.
   * Среднее число посещений по ролям.
   * Прочая сводная статистика.

### Режим агрегации (`AGGREGATE`)

1. Загружаются посещения и штатка.
2. Производится агрегация по уникальным ключам (ФИО, дата, подразделение, таб.номер).
3. Для каждой записи определяется:

   * Период "месяц", "неделя", "две недели" согласно гибким правилам (см. ниже).
4. В агрегированные записи подмешивается роль из штатки.
5. Формируется summary-отчёт по сотрудникам:

   * Признак дубля по таб.номеру.
   * Присутствие хотя бы одного посещения в каждом из периодов (месяц, неделя, 2 недели).
6. Всё сохраняется в CSV и Excel.
7. В логах:

   * Время каждого этапа.
   * Финальная статистика: сколько обработано строк, уникальных записей, среднее по ролям.

---

## Логика расчёта периодов

### Месяц (M-0, M-1, ...)

* Если максимальная дата месяца ≤ `period_day_month_border`, то **M-0 включает оба**: прошлый месяц и часть текущего до max\_date.
* Иначе **M-0** — только текущий месяц до max\_date.

### Неделя (N-0, N-1, ...)

* Если день недели максимальной даты ≤ `period_weekday_border`, то **N-0** начинается с прошлого понедельника (две недели до max\_date).
* Иначе — с текущего понедельника.

### Две недели (2N-0, 2N-1, ...)

* Логика аналогична неделям: если день недели max\_date ≤ `period_weekday_border`, то две последние недели считаются расширенными назад.

### Все периоды вычисляются автоматически и отражаются в summary-отчёте (1 — было посещение, 0 — не было).

---

## Структура файлов и каталогов

```
project/
├── IN_BASE/
│   └── ORG_UNIT.csv
│   └── EMPLOYEE_VISITS.csv
│   └── EMPLOEE.csv
├── OUT_CSV/
│   └── EMPLOEE_*.csv
│   └── EMPLOYEE_VISITS_*.csv
│   └── VISIT_AGGREGATED_*.csv
│   └── SUMMARY_*.csv
├── LOGS/
│   └── LOG_*.log
│   └── AGG_LOG_*.log
├── main.py
```

---

## Пример запуска

Для генерации данных:

```python
MODE = "GENERATE"
```

Запустить `main.py`.

Для агрегации:

```python
MODE = "AGGREGATE"
```

Запустить `main.py`.

---

## Пример лога

```
2025-07-17 00:50:09,543 [INFO] === START RUN ===
2025-07-17 00:50:09,543 [INFO] Режим агрегации посещений
...
2025-07-17 00:50:59,237 [INFO] Дозаполнение ROLE_CODE из штатки (join по TN)...
2025-07-17 00:50:59,264 [INFO] Финальный размер: (223309, 11)
2025-07-17 00:50:59,264 [INFO] Формируем данные для SUMMARY листа...
2025-07-17 00:51:05,300 [INFO] Время выполнения aggregate: 55.76 сек
```

---

## Обработка ошибок

* Все ошибки логируются.
* При критических ошибках программа завершает работу с выводом причины.

---

## Контакты для поддержки

* Ответственный разработчик: \[ФИО, почта, телефон]
* Вопросы по методологии: \[контакт]

---

**Примечание:** Если изменяется логика периодов, корректируйте параметры в `AGG_PARAMS`!
Для поддержки и расширения — открывайте issue или связывайтесь с автором.

---