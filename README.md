---

# Генератор сотрудников и посещений ресурса

## Описание задачи

Скрипт предназначен для автоматической генерации тестовой базы сотрудников организации с подробным распределением по подразделениям, ролям и уникальными ФИО, а также формирования таблицы посещения ресурса этими сотрудниками по заданному датовому диапазону с реалистичной моделью посещаемости.

### Ключевые требования задачи

1. **Генерация сотрудников:**

   * Количество сотрудников (по умолчанию — 8000) задаётся параметрами.
   * ФИО уникальные (мужские и женские, с контролем полного совпадения).
   * Уникальный табельный номер (TN), всегда 10 знаков (лидирующие нули при необходимости).
   * Каждый сотрудник распределён по подразделениям (структура загружается из файла ORG\_UNIT.csv).
   * Пропорциональное распределение по подразделениям с небольшими случайными отклонениями.
   * Распределение по ролям согласно параметрам (`role_distribution`).
   * Итоговый список сохраняется в CSV и Excel с автоформатированием и жирными заголовками.

2. **Генерация посещений:**

   * Для всех сотрудников формируется история посещения ресурса за период (по умолчанию: 2025-01-01 — 2025-07-12).
   * Посещения не ежедневные:

     * 30% сотрудников посещают крайне редко (1–5 раз за период).
     * 5% сотрудников — почти ежедневно (по рабочим дням, иногда и выходные).
     * Остальные — с разбросом (от 10 до 50 посещений, преимущественно в рабочие дни).
   * Общая целевая плотность таблицы — 900 000 строк (регулируется параметром).
   * Таблица сохраняется в CSV и Excel, с автоформатированием.
   * Все имена файлов содержат уникальный таймштамп генерации.

3. **Логирование:**

   * Подробный лог каждого этапа генерации с сохранением в файл и выводом в консоль.

---

## Запуск

**Требования:**

* Python 3.8+
* `pandas`
* `openpyxl`

Установить зависимости:

```sh
pip install pandas openpyxl
```

---

## Структура и параметры

### Основные параметры

Параметры определяются в начале скрипта:

```python
PARAMS = {
    "input_dir": "ПУТЬ_К_ПАПКЕ_ВХОДНЫХ_ДАННЫХ",         # Папка с ORG_UNIT.csv
    "org_unit_file": "ORG_UNIT.csv",                    # Имя файла структуры подразделений
    "output_dir": "ПУТЬ_К_ПАПКЕ_ВЫХОДНЫХ_ФАЙЛОВ",       # Куда складывать результаты
    "output_base": "EMPLOEE",                           # Базовое имя файлов сотрудников (без расширения)
    "log_dir": "ПУТЬ_К_ПАПКЕ_ЛОГОВ",                    # Куда сохранять логи
    "log_base": "LOG",                                  # Имя файла лога (дополнится датой)
    "user_count": 8000,                                 # Число сотрудников
    "role_distribution": {                              # Распределение по ролям
        "KM_KKSB": 1700,
        "KM_MNS": 200,
        "RUK_KKSB": 320,
        "RUK_MNS": 15,
        "RUK_TB": 30,
        "RUK_CA": 10,
        "DRKB": 50,
        "KM_SB1": 2000,
        "RUK_SB1": 200,
        "UMB1": 500,
        "RUK_UMB1": 10,
        "OTHER_CA": 30,
        "SERVISE_MAN": 1700
    }
}

VISIT_PARAMS = {
    "visit_out_base": "EMPLOYEE_VISITS",                # Имя файлов посещений (без расширения)
    "visit_start_date": "2025-01-01",                   # Дата начала периода
    "visit_end_date": "2025-07-12",                     # Дата конца периода
    "visit_target_row_count": 900_000                   # Целевое число строк
}
```

---

## Описание функций

### 1. Основная точка входа

```python
def main():
    ...
```

* Генерирует сотрудников (и сохраняет их).
* Генерирует посещения на их основе.
* Все имена файлов строятся по шаблону:
  `<output_dir>/<output_base>_<таймштамп>.csv/.xlsx` и
  `<output_dir>/<visit_out_base>_<таймштамп>.csv/.xlsx`

### 2. Генерация сотрудников

```python
def generate_employees(org_units, n_users, role_distribution):
    ...
```

* Генерирует список сотрудников (словари), распределяя их по подразделениям и ролям.
* Уникальность ФИО и табельных номеров гарантируется.
* Мужчины и женщины распределяются примерно поровну.

### 3. Сохранение сотрудников

```python
def save_employees(employees, out_dir, out_base, timestamp=None):
    ...
```

* Сохраняет список сотрудников в CSV и Excel.
* Автоформатирует Excel-файл (ширина колонок по содержимому, заголовки жирные).
* Возвращает DataFrame сотрудников и пути к файлам.

### 4. Генерация посещений

```python
def generate_visits(employees_df, start_date, end_date, target_row_count):
    ...
```

* Формирует визиты для сотрудников по дням согласно распределению посещаемости.
* 30% сотрудников — “редкие” визиты, 5% — почти ежедневные, остальные — умеренные.

### 5. Сохранение посещений

```python
def save_visits(visit_data, out_csv, out_xlsx):
    ...
```

* Сохраняет таблицу посещений в CSV и Excel.
* Автоформатирует Excel-файл.

### 6. Автоформатирование Excel

```python
def autofit_excel_columns(xlsx_path, sheet_name="Sheet1"):
    ...
```

* Делает заголовки жирными и подбирает ширину колонок.

### 7. Загрузка структуры подразделений

```python
def load_org_units(path):
    ...
```

* Загружает структуру подразделений из файла ORG\_UNIT.csv.

---

## Выходные файлы

* Все файлы содержат таймштамп генерации:
  `EMPLOEE_YYYYMMDD_HHMMSS.csv` / `EMPLOEE_YYYYMMDD_HHMMSS.xlsx`
  `EMPLOYEE_VISITS_YYYYMMDD_HHMMSS.csv` / `EMPLOYEE_VISITS_YYYYMMDD_HHMMSS.xlsx`

---

## Используемые переменные

* **employees**: список словарей, описывающих сотрудников.
* **employees\_df**: pandas.DataFrame, данные сотрудников.
* **visit\_data**: список словарей, описывающих посещения (каждая строка — визит в определённую дату).
* **logger**: объект логгера для ведения журнала событий.

---

## Пример запуска

```python
if __name__ == "__main__":
    main()
```

---

## Примечания

* Все входные и выходные директории должны существовать.
* Структура ORG\_UNIT.csv — с разделителем `;`, содержит столбцы:

  * TB\_CODE, TB\_FULL\_NAME, TB\_SHORT\_NAME, GOSB\_CODE, GOSB\_NAME, GOSB\_SHORT\_NAME, ORG\_UNIT\_CODE
* Генерируемый объём (900 000 строк посещений) — большой. Для теста используйте меньшее значение.

---
