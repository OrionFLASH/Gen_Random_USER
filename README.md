
---

# Генератор и агрегатор данных посещений сотрудников

## Назначение

Скрипт предназначен для генерации тестовых данных сотрудников и их посещений, а также для агрегации этих данных по временным периодам (месяц, неделя, двухнедельный период) с последующим формированием сводных таблиц (SUMMARY) для анализа и отчетности.

---

## Возможности

* Генерация сотрудников с уникальными ФИО и табельными номерами, распределением по подразделениям и ролям.
* Генерация таблицы посещений с гарантированным количеством строк.
* Агрегация посещений с построением периодов (месяц, неделя, две недели) по специальной логике, учитывающей положение максимальной даты.
* Формирование Excel/CSV-файлов с подробным логированием и автоформатированием.
* Создание summary-отчета по каждому сотруднику по всем временным периодам.
* Гибкая настройка всех основных параметров через переменные.
* Ведение подробного лога по этапам работы.

---

## Структура проекта

* **main.py** — основной исполняемый файл со всей бизнес-логикой.
* **IN\_BASE/** — входные данные (справочник подразделений, штатка и др.).
* **OUT\_CSV/** — все сгенерированные и агрегированные данные.
* **LOGS/** — файлы логов.

---

## Описание режимов работы

### MODE = "GENERATE"

**1. Генерация сотрудников**

* Чтение файла оргструктуры (`ORG_UNIT.csv`).
* Генерация заданного количества сотрудников с уникальными ФИО, табельными номерами, распределением по подразделениям и ролям.
* Сохранение в `CSV` и `Excel` с автоформатированием.

**2. Генерация посещений**

* Для каждого сотрудника генерируется набор посещаемых дней, который определяется категорией "активности" (см. ниже).
* Итоговое число записей всегда строго равно параметру `visit_target_row_count` (см. логику ниже).
* Сохранение в `CSV` и `Excel` с автоформатированием.

---

### MODE = "AGGREGATE"

**1. Чтение данных**

* Чтение таблицы посещений (`EMPLOYEE_VISITS.csv`) и штатки (`EMPLOEE.csv`).

**2. Агрегация**

* Суммирование посещений по уникальным ключам (сотрудник, дата, подразделение и т.д.).
* Рассчет временных периодов (месяц, неделя, 2 недели) по специальной логике, учитывающей положение максимальной даты (см. ниже).
* Присваивание ролей из штатки.
* Построение summary-листа по сотрудникам.

**3. Формирование SUMMARY**

* Строится таблица, для каждого сотрудника — посещал ли он хотя бы раз в каждом из последних 13 месяцев, 9 недель, 3 двухнедельных периодов.
* Проверка на дубли табельных номеров.
* Сохранение всех данных в Excel (двумя листами) и отдельный CSV.

---

## Логика генерации посещений

### Категории сотрудников по типу активности

При генерации посещений все сотрудники делятся на 3 группы по **проценту сотрудников**:

* **Редкие:** 30% сотрудников

  * Каждый получает посещения случайным образом **от 1 до 5 дней** за весь период.

* **Активные:** 5% сотрудников

  * Каждый посещает почти все рабочие дни (все будни), а также случайные выходные (до 20 шт).

* **Обычные:** 65% сотрудников

  * Каждый посещает случайно выбранные **от 10 до 50 дней**.

> **Важно:**
> Числа 1–5 и 10–50 — это именно **количество дней посещения** на одного сотрудника, а не проценты от общего числа дней.
> Проценты (30%, 5%, 65%) — это **проценты сотрудников** в каждой категории.

**Принцип добора записей:**

* После основного цикла, если итоговое число посещений меньше параметра `visit_target_row_count`,
  происходит случайный добор записей (рандомно выбирается сотрудник и дата),
  пока не будет ровно нужное количество строк.

---

## Специфика расчёта временных периодов (месяц, неделя, две недели)

### Месяц (PERIOD\_MONTH)

* Если максимальная дата ≤ 7 числа месяца, то **M-0** включает **весь предыдущий месяц + текущий до максимальной даты**.
* Если максимальная дата > 7, то **M-0** — только текущий месяц до максимальной даты.
* Остальные месяцы считаются от границы M-0 назад.

### Неделя (PERIOD\_WEEK)

* Если максимальная дата — понедельник/вторник, то N-0 начинается с прошлого понедельника и идет по максимальную дату.
* В остальных случаях N-0 — текущая неделя (с текущего понедельника).
* Остальные недели считаются аналогично назад.

### Две недели (PERIOD\_2WEEK)

* Аналогично неделе: если max\_date в начале недели — две прошлых недели плюс "кусок" текущей.
* В остальных случаях — текущие две недели (с текущего понедельника).

Все параметры по порогам дней и дня недели можно задавать в AGG\_PARAMS.

---

## Описание основных параметров

### `MODE`

* `"GENERATE"` — генерация новых данных
* `"AGGREGATE"` — агрегация существующих посещений

### `PARAMS`

* `input_dir` — папка с входными файлами (оргструктура)
* `org_unit_file` — файл оргструктуры
* `output_dir` — папка для сохранения сгенерированных сотрудников
* `output_base` — базовое имя файла сотрудников
* `user_count` — сколько сотрудников генерировать
* `role_distribution` — распределение ролей по количеству

### `VISIT_PARAMS`

* `visit_out_dir` — куда сохранять посещения
* `visit_out_base` — имя файла посещений
* `visit_start_date`, `visit_end_date` — период генерации
* `visit_target_row_count` — сколько строк посещений гарантированно создать

### `AGG_PARAMS`

* `input_dir`, `output_dir`, имена файлов
* Ключевые поля для группировки
* Параметры пороговых дат для определения периодов (настраиваются)

### `SUMMARY_PARAMS`

* Параметры формирования summary-отчета (лист, поля, перечни периодов, метки дубликатов)

---

## Описание функций

### Генерация сотрудников

* **`generate_unique_fio_set(count, logger)`**
  Генерирует уникальные ФИО с учетом пола.

* **`generate_unique_tn_set(count, logger)`**
  Генерирует уникальные 10-значные табельные номера.

* **`distribute_users(units, n_users, logger)`**
  Распределяет сотрудников по подразделениям равномерно с некоторой случайностью.

* **`generate_employees(org_units, n_users, role_distribution, logger)`**
  Генерирует сотрудников как список словарей с уникальными ФИО, табельными номерами, ролями и принадлежностью к подразделениям.

### Генерация посещений

* **`generate_visits(employees_df, start_date, end_date, target_row_count, logger)`**
  Генерирует таблицу посещений по категориям активности (см. выше),
  затем добирает до нужного числа строк.

* **`save_employees(employees, out_dir, out_base, logger, timestamp=None)`**
  Сохраняет сотрудников в CSV и Excel, автоширина столбцов.

* **`save_visits(visit_data, out_csv, out_xlsx, logger)`**
  Сохраняет посещения в CSV и Excel, автоширина столбцов.

### Агрегация и формирование summary

* **`aggregate(logger)`**
  Выполняет агрегацию посещений, вычисление периодов, добавление ролей и формирование summary-таблицы.
  Сохраняет результат в CSV и Excel.

* **`autofit_excel_columns(xlsx_path, sheet_name="Sheet1")`**
  Форматирует Excel-листы, делает заголовки жирными.

* **`setup_logging(log_dir, log_base)`**
  Настраивает логирование в файл и консоль.

---

## Пример запуска

### Генерация новых данных

```bash
MODE = "GENERATE"
python main.py
```

### Агрегация существующих посещений

```bash
MODE = "AGGREGATE"
python main.py
```

---

## Требования

* Python 3.9+
* pandas
* openpyxl
* python-dateutil

---

## Входные файлы

* `ORG_UNIT.csv` — справочник подразделений (формат: см. пример в коде или документации).

---

## Итоговые файлы

* `EMPLOEE_<timestamp>.csv`/`.xlsx` — сотрудники
* `EMPLOYEE_VISITS_<timestamp>.csv`/`.xlsx` — посещения
* `VISIT_AGGREGATED_<timestamp>.csv`/`.xlsx` — агрегированные посещения
* `SUMMARY_<timestamp>.csv` — summary-таблица
* Все Excel-файлы имеют автоформатирование, summary размещается на отдельном листе.

---

## Журналирование

Вся информация по ходу работы записывается в папку `LOGS` (файл по дате запуска).
Ошибки выводятся и в консоль, и в лог.

Лог содержит:

* Время старта и окончания программы и каждого этапа
* Количество сгенерированных и обработанных строк/сотрудников/посещений
* Распределение по ролям и среднее число посещений по ролям (для агрегации)
* Статистику по времени работы функций
* Ошибки и предупреждения

---

## Изменения и обновления логики

* [x] Добор записей при генерации посещений до нужного количества
* [x] Гибкая логика периодов (месяц/неделя/две недели) с учетом максимальной даты
* [x] Контроль уникальности ФИО и табельных номеров
* [x] Проверка на дубли сотрудников (по TN)
* [x] Актуальные периоды по последней дате данных
* [x] Подробный лог

---

## Контакты

**Олег, Сбербанк, бизнес-аналитик**
Вопросы и предложения: через рабочий мессенджер.

---
