---

# Генератор и агрегатор данных посещений сотрудников

## Назначение

Скрипт предназначен для генерации тестовых данных сотрудников и их посещений, а также для агрегации этих данных по периодам (месяц, неделя, двухнедельный период) с последующим формированием сводных таблиц (SUMMARY) для анализа.

### Возможности:

* Генерация сотрудников с уникальными ФИО и табельными номерами.
* Генерация таблицы посещений с гарантированным количеством строк.
* Агрегация посещений с построением периодов.
* Формирование Excel/CSV файлов с данными и итоговыми сводами.
* Ведение подробного логирования.

---

## Структура

* **main.py** — основной файл, вся логика генерации и агрегации.
* **IN\_BASE/** — входные данные (org\_units и пр.).
* **OUT\_CSV/** — все сгенерированные и агрегированные данные.
* **LOGS/** — файлы логов.

---

## Описание режимов

### MODE = "GENERATE"

1. **Генерация сотрудников**

   * Считывается файл оргструктуры (`ORG_UNIT.csv`).
   * Генерируется заданное число сотрудников с уникальными ФИО, табельными номерами и ролями.
   * Сохраняется в `CSV` и `Excel`.

2. **Генерация посещений**

   * По каждому сотруднику генерируются даты посещения (логика генерации по типу активности).
   * **НОВАЯ ЛОГИКА:** если сгенерировано посещений меньше, чем задано (`visit_target_row_count`), происходит автоматический добор случайных посещений сотрудников до нужного количества.
   * Сохраняется в `CSV` и `Excel`.

---

### MODE = "AGGREGATE"

1. **Чтение данных**

   * Считываются посещения (`EMPLOYEE_VISITS.csv`) и штатка (`EMPLOEE.csv`).
2. **Агрегация**

   * Суммируются посещения по уникальным ключам (сотрудник, дата, подразделение и т.д.).
   * Рассчитываются временные периоды (месяц, неделя, 2 недели) относительно максимальной даты.
   * Присваивается роль из штатки.
3. **Формирование SUMMARY**

   * Строится summary-лист, для каждого сотрудника — посещал ли он хотя бы раз в каждом из последних 13 месяцев, 9 недель, 3 двухнедельных периодов.
   * Проверка на дубли табельных номеров.
   * Выводит полный свод по всем сотрудникам и периодам.
   * Все данные сохраняются в Excel (двумя листами) и в отдельный CSV.

---

## Описание параметров

### Основные переменные

* `MODE`: `"GENERATE"` или `"AGGREGATE"` — режим работы скрипта.
* `PARAMS`: параметры генерации сотрудников.

  * `input_dir`: папка с входными файлами (оргструктура).
  * `org_unit_file`: файл оргструктуры.
  * `output_dir`: папка для сохранения сгенерированных сотрудников.
  * `output_base`: базовое имя файла сотрудников.
  * `user_count`: сколько сотрудников генерировать.
  * `role_distribution`: распределение ролей по количеству.
* `VISIT_PARAMS`: параметры генерации посещений.

  * `visit_out_dir`: куда сохранять посещения.
  * `visit_out_base`: имя файла посещений.
  * `visit_start_date`, `visit_end_date`: период генерации.
  * `visit_target_row_count`: **сколько строк посещений гарантированно создать**.
* `AGG_PARAMS`: параметры агрегации.

  * `input_dir`, `output_dir`, имена файлов.
  * ключевые поля для группировки.
* `SUMMARY_PARAMS`: параметры формирования summary-отчета (лист и поля, перечни периодов, метки дубликатов).

---

## Логика генерации посещений

**Старая логика:**

* Для каждого сотрудника случайным образом генерировались даты посещения в зависимости от типа активности, процесс завершался при достижении нужного числа строк.
* В ряде случаев итоговое количество посещений могло быть меньше требуемого (например, если все сотрудники уже обработаны и строк не хватает).

**Новая логика:**

* После основного цикла, если общее количество строк меньше, чем `visit_target_row_count`, происходит добор случайных записей (рандомно выбирается сотрудник и дата), пока не наберется строго нужное количество строк.
* Итог: **всегда** будет ровно `visit_target_row_count` записей в итоговом файле посещений.

---

## Описание функций

### `generate_unique_fio_set(count, logger)`

Генерирует уникальные ФИО для заданного числа сотрудников с учетом пола.

### `generate_unique_tn_set(count, logger)`

Генерирует уникальные табельные номера (строковые 10-значные).

### `distribute_users(units, n_users, logger)`

Распределяет сотрудников по подразделениям случайно, с учетом более равномерной загрузки.

### `generate_employees(org_units, n_users, role_distribution, logger)`

Генерирует сотрудников как список словарей с уникальными ФИО, номерами, ролями и принадлежностью к подразделениям.

### `generate_visits(employees_df, start_date, end_date, target_row_count, logger)`

Генерирует таблицу посещений с требуемым количеством строк (см. выше).

### `save_employees(employees, out_dir, out_base, logger, timestamp=None)`

Сохраняет список сотрудников в CSV и Excel, делает автоширину столбцов.

### `save_visits(visit_data, out_csv, out_xlsx, logger)`

Сохраняет посещения в CSV и Excel, делает автоширину столбцов.

### `aggregate(logger)`

Выполняет агрегацию посещений, вычисление периодов, добавление роли и формирование сводной таблицы (summary). Все результаты сохраняются в CSV и Excel.

### `autofit_excel_columns(xlsx_path, sheet_name="Sheet1")`

Делает автоширину и выделяет заголовки.

### `setup_logging(log_dir, log_base)`

Настраивает логирование в файл и консоль с автоочисткой хендлеров.

---

## Пример запуска

### Генерация новых данных

```bash
MODE = "GENERATE"
python main.py
```

### Агрегация существующих посещений

```bash
MODE = "AGGREGATE"
python main.py
```

---

## Требования

* Python 3.9+
* pandas
* openpyxl
* dateutil

---

## Входные файлы

* `ORG_UNIT.csv` — справочник подразделений (см. пример структуры в коде).

---

## Итоговые файлы

* `EMPLOEE_<timestamp>.csv`/`.xlsx` — сотрудники.
* `EMPLOYEE_VISITS_<timestamp>.csv`/`.xlsx` — посещения.
* `VISIT_AGGREGATED_<timestamp>.csv`/`.xlsx` — агрегированные посещения.
* `SUMMARY_<timestamp>.csv` — сводная summary-таблица.
* Все Excel-файлы имеют автоформатирование, summary размещается на отдельном листе.

---

## Журналирование

Вся информация по ходу работы записывается в папку `LOGS` (файл по дате запуска).
Ошибки выводятся и в консоль, и в лог.

---

## Изменения и обновления логики

* [x] **Добор записей при генерации посещений до нужного количества**
* [x] Контроль уникальности ФИО и табельных номеров
* [x] Проверка на дубли сотрудников (по TN)
* [x] Актуальные периоды по последней дате данных
* [x] Гибкая настройка распределения ролей
* [x] Подробный лог

---

## Автор / поддержка

**Олег, Сбербанк, бизнес-аналитик**
Вопросы/замечания: через рабочий мессенджер.

---